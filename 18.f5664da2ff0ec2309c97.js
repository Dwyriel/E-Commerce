(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{"2MiI":function(t,e,i){"use strict";i.d(e,"a",function(){return h});var s=i("OGMK"),n=i("fXoL"),r=i("ofXK"),o=i("TEn/");function c(t,e){if(1&t&&(n.Rb(0,"ion-header",3),n.Rb(1,"ion-toolbar"),n.Rb(2,"ion-buttons",4),n.Nb(3,"ion-menu-button"),n.Qb(),n.Rb(4,"ion-title"),n.rc(5),n.Qb(),n.Qb(),n.Qb()),2&t){const t=n.bc();n.hc("translucent",!0),n.Bb(5),n.sc(t.title)}}function a(t,e){if(1&t&&(n.Rb(0,"ion-header",5),n.Rb(1,"ion-toolbar"),n.Rb(2,"ion-title",6),n.rc(3),n.Qb(),n.Qb(),n.Qb()),2&t){const t=n.bc();n.Bb(3),n.sc(t.title)}}function d(t,e){1&t&&n.Nb(0,"div",7)}let h=(()=>{class t{constructor(){this.title="",this.isMobile=!0}ngOnInit(){this.subscription&&!this.subscription.closed&&this.subscription.unsubscribe(),this.subscription=s.a.GetAppInfo().subscribe(t=>{this.isMobile=t.appWidth<=s.a.maxMobileWidth})}ngOnDestroy(){this.subscription&&!this.subscription.closed&&this.subscription.unsubscribe()}}return t.\u0275fac=function(e){return new(e||t)},t.\u0275cmp=n.Gb({type:t,selectors:[["app-header"]],inputs:{title:"title",segment:"segment"},decls:3,vars:3,consts:[[3,"translucent",4,"ngIf"],["collapse","condense",4,"ngIf"],["style","width: 100%; height: 65px;",4,"ngIf"],[3,"translucent"],["slot","start"],["collapse","condense"],["size","large"],[2,"width","100%","height","65px"]],template:function(t,e){1&t&&(n.qc(0,c,6,2,"ion-header",0),n.qc(1,a,4,1,"ion-header",1),n.qc(2,d,1,0,"div",2)),2&t&&(n.hc("ngIf",e.isMobile&&"0"==e.segment),n.Bb(1),n.hc("ngIf",e.isMobile&&"1"==e.segment),n.Bb(1),n.hc("ngIf",!e.isMobile&&"0"==e.segment))},directives:[r.k,o.o,o.T,o.f,o.B,o.S],styles:[""]}),t})()},Zfjo:function(t,e,i){"use strict";i.r(e),i.d(e,"ChatPageModule",function(){return C});var s=i("ofXK"),n=i("3Pt+"),r=i("TEn/"),o=i("tyNb"),c=i("mrSG"),a=i("OGMK");class d{}var h=i("CbRh"),u=i("fXoL"),l=i("xHty"),b=i("lJxs"),p=i("I/3d");let g=(()=>{class t{constructor(t){this.fireDatabase=t,this.collection="PurchaseChat"}Add(t){return Object(c.b)(this,void 0,void 0,function*(){return yield this.fireDatabase.collection(this.collection).add({purchaseId:t.purchaseId,senderId:t.senderId,message:t.message,date:(new Date).getTime()})})}Get(t){return Object(c.b)(this,void 0,void 0,function*(){return this.fireDatabase.collection(this.collection).doc(t).valueChanges()})}GetAllFromPurchase(t){return Object(c.b)(this,void 0,void 0,function*(){return this.fireDatabase.collection(this.collection,e=>e.where("purchaseId","==",t).orderBy("date","asc")).snapshotChanges().pipe(Object(b.a)(t=>t.map(t=>Object.assign(Object.assign({id:t.payload.doc.id},t.payload.doc.data()),{date:new Date(t.payload.doc.data().date)}))))})}GetLatestFromPurchase(t){return Object(c.b)(this,void 0,void 0,function*(){return this.fireDatabase.collection(this.collection,e=>e.where("purchaseId","==",t).orderBy("date","desc").limit(1)).snapshotChanges().pipe(Object(b.a)(t=>t.map(t=>Object.assign(Object.assign({id:t.payload.doc.id},t.payload.doc.data()),{date:new Date(t.payload.doc.data().date)}))))})}Update(t,e){return Object(c.b)(this,void 0,void 0,function*(){return yield this.fireDatabase.collection(this.collection).doc(t).update({message:e})})}deletePurchaseChatsFrom(t){return Object(c.b)(this,void 0,void 0,function*(){var e,i=(yield this.GetAllFromPurchase(t)).subscribe(t=>Object(c.b)(this,void 0,void 0,function*(){e=t;const s=this.fireDatabase.firestore.batch();e.forEach(t=>{var e=this.fireDatabase.firestore.collection(this.collection).doc(t.id);s.delete(e)}),yield s.commit(),i.unsubscribe()}))})}Delete(t){return Object(c.b)(this,void 0,void 0,function*(){return yield this.fireDatabase.collection(this.collection).doc(t).delete()})}}return t.\u0275fac=function(e){return new(e||t)(u.Vb(p.a))},t.\u0275prov=u.Ib({token:t,factory:t.\u0275fac,providedIn:"root"}),t})();var f=i("qfBg"),m=i("3LUQ"),v=i("2MiI");function y(t,e){if(1&t&&u.Nb(0,"img",13),2&t){const t=u.bc(2);u.hc("src",t.otherUser.photo?t.otherUser.photo:"assets/perfil.png",u.oc)("alt",t.otherUser.name)}}function O(t,e){if(1&t&&u.Nb(0,"img",13),2&t){const t=u.bc(2);u.hc("src",t.loggedUser.photo?t.loggedUser.photo:"assets/perfil.png",u.oc)("alt",t.loggedUser.name)}}function M(t,e){if(1&t&&(u.Pb(0),u.Rb(1,"div",10),u.Rb(2,"ion-row"),u.qc(3,y,1,2,"img",11),u.Rb(4,"div",12),u.Rb(5,"p"),u.rc(6),u.Qb(),u.Rb(7,"span"),u.rc(8),u.Qb(),u.Qb(),u.qc(9,O,1,2,"img",11),u.Qb(),u.Qb(),u.Ob()),2&t){const t=e.$implicit,i=u.bc();u.Bb(2),u.Db("ion-align-items-start ion-justify-content-",t.senderId==i.loggedUser.id?"end":"start",""),u.Bb(1),u.hc("ngIf",t.senderId!=i.loggedUser.id),u.Bb(2),u.Db("",t.senderId==i.loggedUser.id?"sent_text":"received_text"," text"),u.Bb(1),u.sc(t.message),u.Bb(1),u.Db("time_date ",t.senderId==i.loggedUser.id?"float-right":"float-left",""),u.Bb(1),u.tc(" ",t.date.toLocaleString(),""),u.Bb(1),u.hc("ngIf",t.senderId==i.loggedUser.id)}}const w=function(t){return{webrowser:t}},I=function(t){return{chatWidth:t}},P=[{path:"",component:(()=>{class t{constructor(t,e,i,s,n,r,o){this.activatedRoute=t,this.purchaseService=e,this.chatService=i,this.userService=s,this.alertService=n,this.router=r,this.navController=o,this.title="Carregando",this.loggedUser=new h.a,this.otherUser=new h.a,this.messages=[],this.inputedText="",this.purchase=null,this.shouldBreak=!1,this.interruptWhile=!1,this.messageSent=!0}ngOnInit(){}ionViewWillEnter(){return Object(c.b)(this,void 0,void 0,function*(){this.shouldBreak=!1,this.GetPlataformInfo(),yield this.getLoggedUser(),yield this.GetPurchase(),this.setInputPadding()})}ionViewWillLeave(){this.shouldBreak=!0,this.messageSent=!0,this.title="Carregando",this.loggedUser=new h.a,this.otherUser=new h.a,this.purchase=null,this.messages=[],this.subscription1&&!this.subscription1.closed&&this.subscription1.unsubscribe(),this.subscription2&&!this.subscription2.closed&&this.subscription2.unsubscribe(),this.subscription3&&!this.subscription3.closed&&this.subscription3.unsubscribe(),this.subscription4&&!this.subscription4.closed&&this.subscription4.unsubscribe(),this.subscription5&&!this.subscription5.closed&&this.subscription5.unsubscribe(),this.subscription6&&!this.subscription6.closed&&this.subscription6.unsubscribe()}GetPlataformInfo(){this.subscription1=a.a.GetAppInfo().subscribe(t=>{this.isMobile=t.appWidth<=a.a.maxMobileWidth,this.isDesktopPlatform=t.platform==a.b.desktop,this.setDivWidth(.4*t.appWidth>a.a.maxMobileWidth/1.5?"40%":a.a.maxMobileWidth/1.5+"px")})}setDivWidth(t){document.body.style.setProperty("--maxWidth",t)}setInputPadding(){return Object(c.b)(this,void 0,void 0,function*(){yield new Promise(t=>setTimeout(t,1e3));for(var t=document.getElementById("input-textarea"),e=-1;;)if(yield new Promise(t=>setTimeout(t,100)),this.interruptWhile&&(yield new Promise(t=>setTimeout(t,1e3)),this.interruptWhile=!1),t.offsetHeight!=e){var i=t.offsetHeight+(0==t.offsetHeight?65:30);if(document.body.style.setProperty("--reqPadding",i+"px"),this.content.scrollByPoint(0,i,0),e=t.offsetHeight,this.shouldBreak)break}})}getLoggedUser(){return Object(c.b)(this,void 0,void 0,function*(){this.subscription2=a.a.GetUserInfo().subscribe(t=>{t?this.loggedUser=t:this.SendAway("/login")},t=>Object(c.b)(this,void 0,void 0,function*(){yield this.alertService.dismissLoading(this.loadingAlertID),yield this.alertService.presentAlert("Ops","Algo deu errado, tente novamente mais tarde.")}))})}GetPurchase(){return Object(c.b)(this,void 0,void 0,function*(){yield this.alertService.presentLoading().then(t=>this.loadingAlertID=t),this.id=this.activatedRoute.snapshot.paramMap.get("id"),this.id?this.subscription3=(yield this.purchaseService.Get(this.id)).subscribe(t=>Object(c.b)(this,void 0,void 0,function*(){!t||t.sellerId!=this.loggedUser.id&&t.userId!=this.loggedUser.id?yield this.SendAway("/"):(this.purchase=t,this.purchase.id=this.id,this.title=`Conversa: Compra ${this.purchase.id}`,yield this.GetMessages(),yield this.GetOtherUser(),yield this.alertService.dismissLoading(this.loadingAlertID))}),t=>Object(c.b)(this,void 0,void 0,function*(){this.ErrorHandling("Ops","Ocorreu um erro ao carregar o chat, tente novamente mais tarde.")})):yield this.SendAway("/")})}GetMessages(){return Object(c.b)(this,void 0,void 0,function*(){var t=!0;for(this.subscription4&&!this.subscription4.closed&&this.subscription4.unsubscribe(),this.subscription4=(yield this.chatService.GetAllFromPurchase(this.purchase.id)).subscribe(e=>{this.messages=e,this.scrollToBotton(),this.subscription4&&!this.subscription4.closed&&this.subscription4.unsubscribe(),this.PostMessagesSubscription(),t=!1},e=>{this.ErrorHandling("Ops","Ocorreu um erro ao carregar as mensagens, tente novamente mais tarde.",!1),t=!1});t;)yield new Promise(t=>setTimeout(t,10))})}PostMessagesSubscription(){return Object(c.b)(this,void 0,void 0,function*(){this.subscription5&&!this.subscription5.closed&&this.subscription5.unsubscribe(),this.subscription5=(yield this.chatService.GetLatestFromPurchase(this.purchase.id)).subscribe(t=>{this.messageSent?this.messageSent=!1:(this.messages.push(t[0]),this.scrollToBotton())},t=>Object(c.b)(this,void 0,void 0,function*(){this.ErrorHandling("Ops","Ocorreu um erro ao carregar novas mensagens, tente novamente mais tarde.",!1)}))})}GetOtherUser(){return Object(c.b)(this,void 0,void 0,function*(){var t=!0,e=this.loggedUser.id==this.purchase.sellerId?this.purchase.userId:this.purchase.sellerId;for(this.subscription6&&!this.subscription6.closed&&this.subscription6.unsubscribe(),this.subscription6=(yield this.userService.Get(e)).subscribe(e=>{this.otherUser=e,this.title=`Conversa: ${this.otherUser.name}`,t=!1},e=>{this.ErrorHandling("Ops","Algo deu errado, tente novamente mais tarde.",!1),t=!1});t;)yield new Promise(t=>setTimeout(t,10))})}ErrorHandling(t,e,i=!0){return Object(c.b)(this,void 0,void 0,function*(){yield this.alertService.dismissLoading(this.loadingAlertID),yield this.alertService.presentAlert(t,e),i&&this.navController.back()})}SendAway(t){return Object(c.b)(this,void 0,void 0,function*(){yield this.router.navigate([t]),yield this.alertService.dismissLoading(this.loadingAlertID)})}EnterKeyInput(){return Object(c.b)(this,void 0,void 0,function*(){this.isDesktopPlatform&&(yield this.SendMessage())})}SendMessage(){return Object(c.b)(this,void 0,void 0,function*(){if(""!=this.inputedText&&null!=this.inputedText){var t=this.CreateMessageObject(this.inputedText);this.subscription5&&!this.subscription5.closed&&this.subscription5.unsubscribe(),this.messageSent=!0,yield this.chatService.Add(t).then(e=>{this.inputedText="",this.interruptWhile=!0,t.date=new Date,this.messages.push(t),this.scrollToBotton(),this.PostMessagesSubscription()}).catch(t=>{this.PostMessagesSubscription(),this.alertService.presentAlert("Erro","N\xe3o foi possivel enviar sua mensagem. Tente novamente.")})}})}CreateMessageObject(t){var e=new d;return e.purchaseId=this.purchase.id,e.senderId=this.loggedUser.id,e.message=t,e}scrollToBotton(){this.interruptWhile=!0,setTimeout(()=>{this.content.scrollToBottom(500)},300)}}return t.\u0275fac=function(e){return new(e||t)(u.Mb(o.a),u.Mb(l.a),u.Mb(g),u.Mb(f.a),u.Mb(m.a),u.Mb(o.g),u.Mb(r.Y))},t.\u0275cmp=u.Gb({type:t,selectors:[["app-chat"]],viewQuery:function(t,e){if(1&t&&u.vc(r.m,1),2&t){let t;u.lc(t=u.ac())&&(e.content=t.first)}},decls:11,vars:11,consts:[["segment","0",3,"title"],[3,"fullscreen"],["segment","1",3,"title"],[3,"ngClass"],[4,"ngFor","ngForOf"],[1,"requiredPadding"],[1,"input-area",2,"width","100%",3,"ngClass"],["id","input-textarea","name","input-text","spellcheck","true","autoGrow","true",3,"ngModel","ngModelChange","keyup.enter"],["button","",3,"click"],["slot","end","ios","send-outline","md","send-sharp",2,"width","2rem"],[1,"message"],["class","user_img",3,"src","alt",4,"ngIf"],[1,"text_div"],[1,"user_img",3,"src","alt"]],template:function(t,e){1&t&&(u.Nb(0,"app-header",0),u.Rb(1,"ion-content",1),u.Nb(2,"app-header",2),u.Rb(3,"div",3),u.Rb(4,"div"),u.qc(5,M,10,13,"ng-container",4),u.Nb(6,"div",5),u.Qb(),u.Rb(7,"ion-item",6),u.Rb(8,"ion-textarea",7),u.Zb("ngModelChange",function(t){return e.inputedText=t})("keyup.enter",function(){return e.EnterKeyInput()}),u.Qb(),u.Rb(9,"ion-item",8),u.Zb("click",function(){return e.SendMessage()}),u.Nb(10,"ion-icon",9),u.Qb(),u.Qb(),u.Qb(),u.Qb()),2&t&&(u.hc("title",e.title),u.Bb(1),u.hc("fullscreen",!0),u.Bb(1),u.hc("title",e.title),u.Bb(1),u.hc("ngClass",u.kc(7,w,!e.isMobile)),u.Bb(2),u.hc("ngForOf",e.messages),u.Bb(2),u.hc("ngClass",u.kc(9,I,!e.isMobile)),u.Bb(1),u.hc("ngModel",e.inputedText))},directives:[v.a,r.m,s.i,s.j,r.s,r.R,r.eb,n.f,n.i,r.p,r.H,s.k],styles:[".webrowser[_ngcontent-%COMP%]{width:var(--maxWidth);margin:0 auto}.chatWidth[_ngcontent-%COMP%]{width:var(--maxWidth)!important}.user_img[_ngcontent-%COMP%]{border-radius:50%;margin:0 .5rem;height:2.5rem;width:2.5rem}.received_text[_ngcontent-%COMP%]{background:#0089d8;color:#fff}.time_date[_ngcontent-%COMP%]{color:#747474;font-size:.7rem;margin:8px 0 0}.message[_ngcontent-%COMP%]{margin-top:26px}.text_div[_ngcontent-%COMP%]{max-width:65%}.sent_text[_ngcontent-%COMP%]{background:#ebebeb;color:#646464}.text[_ngcontent-%COMP%]{border-radius:5px;margin:0;font-size:14px;padding:5px 10px;white-space:pre-wrap}.float-left[_ngcontent-%COMP%]{float:left}.float-right[_ngcontent-%COMP%]{float:right}.input-area[_ngcontent-%COMP%]{position:fixed;margin-top:1rem;bottom:0}.requiredPadding[_ngcontent-%COMP%]{height:var(--reqPadding)}"]}),t})()}];let x=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=u.Kb({type:t}),t.\u0275inj=u.Jb({imports:[[o.k.forChild(P)],o.k]}),t})();var j=i("dagM");let C=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=u.Kb({type:t}),t.\u0275inj=u.Jb({imports:[[s.b,n.a,r.U,x,j.a]]}),t})()},dagM:function(t,e,i){"use strict";i.d(e,"a",function(){return a});var s=i("ofXK"),n=i("3Pt+"),r=i("tyNb"),o=i("TEn/"),c=i("fXoL");let a=(()=>{class t{}return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=c.Kb({type:t}),t.\u0275inj=c.Jb({imports:[[o.U,s.b,n.a,r.k]]}),t})()}}]);